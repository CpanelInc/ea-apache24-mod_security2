From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Daniel Muey <dan@cpanel.net>
Date: Wed, 28 Feb 2018 12:04:52 -0600
Subject: [PATCH 5/6] =?UTF-8?q?Do=20not=20generate=20SecHashKey=20when=20S?=
 =?UTF-8?q?ecHashEngine=20isn=E2=80=99t=20on?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 apache2/apache2_config.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/apache2/apache2_config.c b/apache2/apache2_config.c
index ce97950..9a7b7b5 100644
--- a/apache2/apache2_config.c
+++ b/apache2/apache2_config.c
@@ -732,8 +732,13 @@ void init_directory_config(directory_config *dcfg)
     if (dcfg->col_timeout == NOT_SET) dcfg->col_timeout = 3600;
 
     /* Hash */
-    if (dcfg->crypto_key == NOT_SET_P) dcfg->crypto_key = getkey(dcfg->mp);
-    if (dcfg->crypto_key_len == NOT_SET) dcfg->crypto_key_len = strlen(dcfg->crypto_key);
+    if (dcfg->hash_is_enabled == HASH_ENABLED) {
+        if (dcfg->crypto_key == NOT_SET_P) dcfg->crypto_key = getkey(dcfg->mp);
+        if (dcfg->crypto_key_len == NOT_SET) dcfg->crypto_key_len = strlen(dcfg->crypto_key);
+    } else {
+        if (dcfg->crypto_key == NOT_SET_P) dcfg->crypto_key = "";
+        if (dcfg->crypto_key_len == NOT_SET) dcfg->crypto_key_len = 0;
+    }
     if (dcfg->crypto_key_add == NOT_SET) dcfg->crypto_key_add = HASH_KEYONLY;
     if (dcfg->crypto_param_name == NOT_SET_P) dcfg->crypto_param_name = "crypt";
     if (dcfg->hash_is_enabled == NOT_SET) dcfg->hash_is_enabled = HASH_DISABLED;
